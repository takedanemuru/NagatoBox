' Gambas module file

Private $cpuUsages As New Collection
Private $cpuTimeDifference As Integer
Private $cpuTimeTotal As Integer

Private Function getCpuStatus() As String
    
    Dim yukiLine As String
    Dim yukiElements As String[]
    Dim yukiResult As Integer
    Dim yukiCount As Integer
    
    Exec ["head", "-n", "1", "/proc/stat"] To yukiLine
    
    yukiElements = Split(yukiLine, " ", "", True)
    
    For yukiCount = 1 To 8
        yukiResult += CInt(yukiElements[yukiCount])
    Next
    
    Return yukiResult
    
End

Public Sub SetCpuTimes()
    
    Dim yukiCurrentTotal As Integer = getCpuStatus()
    
    If $cpuTimeTotal = 0 Then
        $cpuTimeTotal = yukiCurrentTotal
        $cpuTimeDifference = 0
    Else
        $cpuTimeDifference = yukiCurrentTotal - $cpuTimeTotal
        $cpuTimeTotal = yukiCurrentTotal
    Endif
    
End

Private Function getCpuUsage(argTotalUsage As Integer, argData As String[]) As Float
    
    Dim yukiBuffer As Integer = CInt(argTotalUsage) - CInt($cpuUsages[argData[0]])
    
    $cpuUsages[argData[0]] = argTotalUsage
    
    If yukiBuffer = 0 Then Return 0
    If $cpuTimeDifference = 0 Then Return 0
    
    Return yukiBuffer / $cpuTimeDifference
    
End

Public Function CpuUsageInFloat(argData As String[]) As Float
    
    Dim yukiTotalUsage As Integer = CInt(argData[13]) + CInt(argData[14])
    
    If yukiTotalUsage = 0 Then Return 0
    If $cpuUsages.Exist(argData[0]) Then Return getCpuUsage(yukiTotalUsage, argData)
        
    $cpuUsages[argData[0]] = yukiTotalUsage
    Return 0
    
End

Public Function PageToMiB(argData As String) As String
    
    If argData <> 0 Then
        Return Format$(CInt(argData) / 256, "#,##0.00MiB") '1page=4KiB(1/256MiB)
    Else
        Return "-"
    Endif
    
End

Public Function KiloByteToMiB(argData As String) As String
    
    If argData <> 0 Then
        Return Format$(CInt(argData) / (1024 ^ 2), "###,###,###,##0.00MiB") 'byte to MiB
    Else
        Return "-"
    Endif
    
Catch
    Return "?"
    
End

Public Function UsageToString(argCpuUsage As Float) As String
    
    If argCpuUsage = 0 Then
        Return "-"
    Else
        Return Format$(argCpuUsage, "##0.00%")
    Endif
    
End
