' Gambas module file

Private Const TileSize As Integer = 128
Private Const TextWidth As Integer = 112
Private Const IconSize As Integer = 64
Private Const Margin As Integer = 8

Private $selectedLabelPainter As New NagatoPainterSelectedLabel

Private Function getTilePicture(argBaseImage As Image, argIcon As Picture, argText As String, argSelected As Boolean) As Picture
    
    Dim yukiHeight As Integer
    
    With Paint
        .Begin(argBaseImage)
        .Brush = .Color(Color.White)
        .Font.Bold = True
        yukiHeight = .Font.RichTextHeight(argText, TextWidth)
        .DrawPicture(argIcon, (TileSize - argIcon.W) / 2, Margin)
        .RichText(argText, Margin, TileSize - yukiHeight - Margin, TextWidth, yukiHeight, Align.Center)
        .Fill()
        If argSelected Then $selectedLabelPainter.Paint()
        .End()
    End With
    
    Return argBaseImage.Picture
    
End

Private Function getSymbolizedTile(argPicture As Picture, argSymbol As String) As Picture
    
    Dim yukiImage As Image = argPicture.Image
    
    Paint.Begin(yukiImage)
        Paint.DrawImage(MikuruIcon.Get(argSymbol, 32).Image, 8, 8)
    Paint.End()
    
    Return yukiImage.Picture
    
End

Public Function GetApplicationTile(argPath As String, Optional argSize As Integer = TileSize) As Picture
    
    Dim yukiBaseImage As New Image(argSize, argSize, Color.Red + 16777216 * 192) 
    Dim yukiDesktopFile As New DesktopFile(argPath)
    Dim yukiIcon As Picture = MikuruIcon.GetDesktopEntryIcon(argPath, IconSize)
    Dim yukiText As String = yukiDesktopFile.Name
    
    Return getTilePicture(yukiBaseImage, yukiIcon, yukiText, False)
    
End

Public Function GetDirectoryTile(argPath As String, argSelected As Boolean, Optional argSize As Integer = TileSize) As Picture
    
    Dim yukiColor As Integer = (IIf(argSelected, Color.Red, Color.Blue) + 16777216 * 192)
    Dim yukiBaseImage As New Image(argSize, argSize, yukiColor) 
    Dim yukiIcon As Picture = MikuruIcon.GetDirectory(argPath, IconSize)
    Dim yukiFolders As String = Subst$("folder:&1", Dir(argPath, "*", gb.Directory).Count)
    Dim yukiFiles As String = Subst$("file:&1", Dir(argPath, "*", gb.File).Count)
    Dim yukiText As String = File.Name(argPath) & "<br>" & yukiFolders & " " & yukiFiles
    Dim yukiTile As Picture = getTilePicture(yukiBaseImage, yukiIcon, yukiText, argSelected)
    Dim yukiSymbol As String = NagatoDBSymbol.GetSymbolName(argPath)
    
    If yukiSymbol <> "" And If Not NagatoXdg.IsUserDir(argPath) Then
        Return getSymbolizedTile(yukiTile, yukiSymbol)
    Else
        Return yukiTile
    Endif
    
End

Public Function GetFileTile(argPath As String, argSelected As Boolean, Optional argSize As Integer = TileSize) As Picture
    
    Dim yukiColor As Integer = (IIf(argSelected, Color.Red, Color.Magenta) + 16777216 * 192)
    Dim yukiBaseImage As New Image(argSize, argSize, yukiColor) 
    Dim yukiIcon As Picture = Desktop.GetFileIcon(argPath, IconSize)
    Dim yukiText As String = File.Name(argPath)
    Dim yukiTile As Picture = getTilePicture(yukiBaseImage, yukiIcon, yukiText, argSelected)
    Dim yukiSymbol As String = NagatoDBSymbol.GetSymbolName(argPath)
    
    If yukiSymbol <> "" Then
        Return getSymbolizedTile(yukiTile, yukiSymbol)
    Else
        Return yukiTile
    Endif
    
End
