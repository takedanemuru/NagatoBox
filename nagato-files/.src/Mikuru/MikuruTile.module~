' Gambas module file

Private Const TileSize As Integer = 128
Private Const TextWidth As Integer = 112
Private Const IconSize As Integer = 64
Private Const Margin As Integer = 8

Private Function getTilePicture(argBaseImage As Image, argIcon As Picture, argText As String) As Picture
    
    Dim yukiHeight As Integer
    
    With Paint
        .Begin(argBaseImage)
        .Brush = .Color(Color.White)
        .Font.Bold = True
        yukiHeight = .Font.RichTextHeight(argText, TextWidth)
        .DrawPicture(argIcon, (TileSize - argIcon.W) / 2, Margin)
        .RichText(argText, Margin, TileSize - yukiHeight - Margin, TextWidth, yukiHeight, Align.Center)
        .Fill()
        .End()
    End With
    
    Return argBaseImage.Picture
    
End

Private Function getDesktopEntryIcon(argPath As String) As Picture
    
    Dim yukiDesktopFile As New DesktopFile(argPath)
    Dim yukiIcon As Image
    
    If Exist(yukiDesktopFile.Icon) Then
        yukiIcon = Image.Load(yukiDesktopFile.Icon)
        If IconSize > Max(yukiIcon.H, yukiIcon.W) Then
            Return yukiIcon.Picture
        Else
            Return yukiIcon.Stretch(IconSize, IconSize).Picture
        End If
    Else
        Return yukiDesktopFile.GetIcon(IconSize).Picture
    End If
    
End

Public Function GetApplicationTile(argPath As String, Optional argSize As Integer = TileSize) As Picture
    
    Dim yukiBaseImage As New Image(argSize, argSize, Color.Red + 16777216 * 192) 
    Dim yukiDesktopFile As New DesktopFile(argPath)
    Dim yukiIcon As Picture = getDesktopEntryIcon(argPath)
    Dim yukiText As String = yukiDesktopFile.Name
    
    Return getTilePicture(yukiBaseImage, yukiIcon, yukiText)
    
End

Public Function GetDirectoryTile(argPath As String, argSelected As Boolean, Optional argSize As Integer = TileSize) As Picture
    
    Dim yukiColor As Integer = IIf(argSelected, Color.Red, Color.Blue + 16777216 * 192)
    Dim yukiBaseImage As New Image(argSize, argSize, yukiColor) 
    Dim yukiIcon As Picture = MikuruIcon.GetDirectory(argPath, IconSize)
    Dim yukiFolders As String = Subst$("folder:&1", Dir(argPath, "*", gb.Directory).Count)
    Dim yukiFiles As String = Subst$("file:&1", Dir(argPath, "*", gb.File).Count)
    Dim yukiText As String = File.Name(argPath) & "<br>" & yukiFolders & " " & yukiFiles
    
    Return getTilePicture(yukiBaseImage, yukiIcon, yukiText)
    
End

Public Function GetFileTile(argPath As String, argSelected As Boolean, Optional argSize As Integer = TileSize) As Picture
    
    Dim yukiColor As Integer = IIf(argSelected, Color.Red, Color.Magenta + 16777216 * 192)
    Dim yukiBaseImage As New Image(argSize, argSize, yukiColor) 
    Dim yukiIcon As Picture = Desktop.GetFileIcon(argPath, IconSize)
    Dim yukiText As String = File.Name(argPath)
    
    Return getTilePicture(yukiBaseImage, yukiIcon, yukiText)
    
End
