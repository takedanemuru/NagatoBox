' Gambas class file

Inherits NagatoTable

Property Read Count As Integer

Public Enum MatchNone, MatchExact, MatchNameOnly, MatchColorOnly

Public Const TableName As String = "tag"
Public Const ColumnId As String = "id"
Public Const ColumnTagName As String = "tag_name"
Public Const ColumnTagColor As String = "tag_color"

Public Sub _InitilazeTable() 'override
    
    Dim yukiTable As Table
    
    If Not Me._$connection.Tables.Exist(Me.TableName) Then
        yukiTable = Me._$connection.Tables.Add(Me.TableName)
        yukiTable.Fields.Add(Me.ColumnId, db.Serial)
        yukiTable.Fields.Add(Me.ColumnTagName, db.String)
        yukiTable.Fields.Add(Me.ColumnTagColor, db.Integer)
        yukiTable.PrimaryKey = [Me.ColumnId]
        yukiTable.Update()
    Endif
    
End

Public Function Push(argName As String, argColor As Integer) As Integer
    
    Dim yukiResult As Result
    
    Me._$connection.Begin()
        yukiResult = Me._$connection.Create(Me.TableName)
        yukiResult[Me.ColumnTagName] = argName
        yukiResult[Me.ColumnTagColor] = argColor
        yukiResult.Update()
    Me._$connection.Commit()
    
    If Not Error Then Return Me.GetTagId(argName, argColor)
    
Catch
    Me._$connection.Rollback()
    Return NagatoDBTag.SequenceAbort
    
End

Public Function GetTagId(argName As String, argColor As Integer) As Integer
    
    Dim yukiResult As Result 
    
    yukiResult = Me._$connection.Find(Me.TableName, "tag_name = &1 and tag_color = &2", argName, argColor)
    
    Return yukiResult[ColumnId]
    
End

Public Function GetMatch(argName As String, argColor As Integer) As Integer ' As Enum. see above.
    
    Dim yukiNameMatch As Integer = Me._$connection.Find(Me.TableName, "tag_name = &1", argName).Count
    Dim yukiColorMatch As Integer = Me._$connection.Find(Me.TableName, "tag_color = &1", argColor).Count
    
    If yukiNameMatch = 0 And If yukiNameMatch = 0 Then
        Return Me.MatchNone
    Else If Me._$connection.Find(Me.TableName, "tag_name = &1 and tag_color = &2", argName, argColor).Count > 0 Then
        Return Me.MatchExact
    Else If yukiNameMatch > 0 Then
        Return Me.MatchNameOnly
    Else ' If yukiColorMatch > 0
        Return Me.MatchColorOnly
    Endif
    
End

Private Function Count_Read() As Integer

    Return Me._$connection.Find(Me.TableName).Count

End
