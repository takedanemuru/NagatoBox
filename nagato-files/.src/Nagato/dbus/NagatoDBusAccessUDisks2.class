' Gambas class file

Create Static

Private $timer As New Timer As "NagatoTimer"
Private $proxy As DBusProxy
Private $observer As DBusObserver

Private Function getDrivesXml() As String
    
    Dim yukiBusName As String = "org.freedesktop.UDisks2"
    Dim yukiObjectPath As String = "/org/freedesktop/UDisks2/drives"
    Dim yukiOutput As String
    
    Exec ["gdbus", "introspect", "--system", "--dest", yukiBusName, "--object-path", yukiObjectPath, "--xml"] To yukiOutput
    
    Return yukiOutput
    
End

Public Sub Activate()
    
    Dim yukiXmlDocument As New XmlDocument
    Dim yukiNode As XmlNode
    Dim yukiProxy As DBusProxy
    Dim yukiObjectPath As String
    Dim yukiInterface As String
    
    yukiXmlDocument.FromString(getDrivesXml())
    
    For Each yukiNode In yukiXmlDocument.GetElementsByTagName("node")
        If yukiNode.Attributes.Count = 0 Then Continue
        yukiObjectPath = Subst$("/org/freedesktop/UDisks2/Drives/&1", yukiNode.Attributes["name"])
        yukiInterface = "org.freedesktop.UDisks2.Drive"
        Try yukiProxy = DBus["System://org.freedesktop.UDisks2"][yukiObjectPath, yukiInterface]
        If Not Error Then Debug yukiProxy.Children.Count
    Next
    
End
