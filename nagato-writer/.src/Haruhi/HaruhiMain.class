' Gambas class file

Private $fileHandler As New NagatoFileHandler
Private $menuPanel As NagatoMenuPanel
Private $sourceEditor As NagatoSourceEditor
Private $previewer As NagatoPreviewer

Private Sub fileEvent(argEvent As Integer)
    
    Select Case argEvent
        Case MikuruSignal.FileOpen
            If $fileHandler.Open() Then $sourceEditor.Text = $fileHandler.Buffer
        Case MikuruSignal.FileSave, MikuruSignal.FileSaveAs
            If argEvent = MikuruSignal.FileSave Then $fileHandler.Save($sourceEditor.Text)
            If argEvent = MikuruSignal.FileSaveAs Then $fileHandler.SaveAs($sourceEditor.Text)
            If Not NagatoSettings.LivePreview Then $previewer.Refresh($sourceEditor.Text)
    End Select
    
End

Private Sub publishEvent(argEvent As Integer)
    
    Select Case argEvent
        Case MikuruSignal.PublishPdf
            If $sourceEditor.Text Then MikuruPublisher.ToPdf($sourceEditor.Text)
        Case MikuruSignal.PublishHtml
            If $sourceEditor.Text Then MikuruPublisher.ToHtml($sourceEditor.Text)
        Case MikuruSignal.PublishPlainText
            If $sourceEditor.Text Then MikuruPublisher.ToPlainText($sourceEditor.Text)
        Case MikuruSignal.PublishSlidy
            If $sourceEditor.Text Then MikuruPublisher.ToSlidy($sourceEditor.Text)
    End Select
    
End

Private Sub appEvent(argEvent As Integer)
    
    Select Case argEvent
        Case MikuruSignal.AppAbout
            HaruhiAbout.ShowDialog()
        Case MikuruSignal.AppQuit
            Me.Close()
    End Select
    
End

Public Sub SetPath(argPath As String)
    
    $sourceEditor.Text = $fileHandler.SetPath(argPath)
    
End

Public Sub _new()

    Application.MainWindow = Me

End

Public Sub Form_Open()

    NagatoSettings.LoadFormSettings(Me)

    $menuPanel = New NagatoMenuPanel(MenuPanelContainer) As "TFEI"
    $sourceEditor = New NagatoSourceEditor(MainContainer) As "TFEI"
    $previewer = New NagatoPreviewer(MainContainer) ' has no user control

    '$sourceEditor.Text = File.Load("Test/TestMarkdownGitHub.md") ' for testing only, must be removed.

End

Public Sub Form_Close()
    
    NagatoSettings.SaveFormSettings(Me)
    
End

Public Sub TFEI_Signal(argEvent As Integer, argArgs As Variant[])
    
    Debug argEvent
    
    Select Case argEvent
        Case MikuruSignal.FileNone To MikuruSignal.FileNone + 999
            fileEvent(argEvent)
        Case MikuruSignal.PublishNone To MikuruSignal.PublishNone + 999
            publishEvent(argEvent)
        Case MikuruSignal.ViewPreview
            $previewer.Refresh($sourceEditor.Text)
        Case MikuruSignal.AppNone To MikuruSignal.AppNone + 999
            appEvent(argEvent)
    End Select
    
End
