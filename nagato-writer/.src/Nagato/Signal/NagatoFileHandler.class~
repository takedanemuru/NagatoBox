' Gambas class file

Inherits NagatoSignal

Property Read Buffer As String
Property Read Path As String

Private $headers As New NagatoSourceHeaders
Private $buffer As New NagatoFileBufferHandler

Public Function GetHeaderIndex(argLine As Integer) As Integer
    
    Dim yukiLine As String
    Dim yukiKey As Integer
    
    For Each yukiLine In $headers.Headers
        yukiKey = CInt($headers.Headers.Key) 
        If argLine > yukiKey Then Continue
        If argLine = yukiKey Then Return $headers.GetIndex(yukiKey) 
        Return $headers.GetIndex(yukiKey) - 1
    Next
    
    Return -1
    
End

Public Function SetPath(argPath As String) As String
    
    $buffer.SetPath(argPath)
    $headers.Refresh($buffer.Text)
    
    Return $buffer.Text
    
End

Public Sub New() As String
    
    $buffer.New()
    $headers.Refresh($buffer.Text)
    
    Return ""
    
End

Public Function Open() As Boolean
    
    If $buffer.Open() Then
        $headers.Refresh($buffer.Text)
        Return True
    Else
        Return False
    Endif
    
End

Public Sub Save(argText As String)
    
    If argText = $buffer.Text Then Return
    
    $buffer.Save(argText)
    $headers.Refresh(argText)

End

Public Sub SaveAs(argText As String)
    
    If $buffer.SaveAs(argText) Then $headers.Refresh($buffer.Text)
    
End

Public Function EnsureSaved(argText As String) As Boolean
    
    If argText = $buffer.Text Then Return True
    
    Select Case HaruhiDialogClose.ShowDialog()
        Case HaruhiDialogClose.ResponseCancel
            Return False
        Case HaruhiDialogClose.ResponseDiscard
            Return True
        Case HaruhiDialogClose.ResponseSave
            Raise Signal(MikuruSignal.FileSave, Null)
            Return True
    End Select
    
End

Private Function Buffer_Read() As String

    Return $buffer.Text

End

Private Function Path_Read() As String

    Return $buffer.Path

End
