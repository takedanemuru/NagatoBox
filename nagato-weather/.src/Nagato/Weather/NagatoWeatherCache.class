' Gambas class file

Create Static

Property Read IsReady As Boolean

Private $cache As New Collection
Private $ready As Boolean = False
Private $htmlClient As New NagatoHttpClientWeather As "HttpClient"
Private $builder As New NagatoWeatherCacheBuilder

Event Finished

Public Sub Activate(argLatitude As Float, argLongtude As Float)
    
    $ready = False
    $htmlClient(argLatitude, argLongtude)
    
End

Public Sub Reload()
    
    $ready = False
    
    $htmlClient(NagatoSettingsLocation.UserLatitude, NagatoSettingsLocation.UserLongitude)
    
End

Public Function GetWeatherElementMostRecent() As NagatoWeatherElement
    
    Dim yukiWeatherElement As NagatoWeatherElement
    
    For Each yukiWeatherElement In $cache
        If MikuruTimeStamp.IsPast($cache.Key) Then Continue
        Return yukiWeatherElement
    Next
    
End

Public Function HasElement(argTime As String) As Boolean
    
    Return $cache.Exist(argTime)
    
End

Public Function GetElement(argTime As String) As NagatoWeatherElement
    
    Return $cache[argTime]
    
Catch
    Return Null
    
End

Public Sub HttpClient_Finished()
    
    $cache.Clear()
    $cache = $builder.Refresh($htmlClient.Elements)
    $ready = True
    
    Raise Finished
    
End

Private Function IsReady_Read() As Boolean

    Return $ready

End
