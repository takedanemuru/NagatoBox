' Gambas module file

Private Const Command As String = "eyeD3 --add-image=&1:FRONT_COVER &2"

Private $workingDirectory As New NagatoWorkingDirectoryEyeD3

Private Function getPictureFormWorkingDirectory(argSize As Integer) As Picture
    
    Dim yukiImage As Image = Image.Load($workingDirectory[0])
    Dim yukiRate As Float = Max(argSize / yukiImage.H, argSize / yukiImage.W)
    
    Return yukiImage.Stretch(yukiImage.W * yukiRate, yukiImage.H * yukiRate).Picture
    
Catch
    Return Null
    
End

Private Sub setAlbumArtToFile(argPicturePath As String, argMusicPath As String)
    
    Shell Subst$(Command, Quote$(argPicturePath), Quote$(argMusicPath)) Wait
    
End

Private Sub setAlbumArtToCurrentPlayingFile(argPicturePath As String, argMusicPath As String)
    
    NagatoQueue.ChannelPlayControl.Pause()
        setAlbumArtToFile(argPicturePath, argMusicPath)
    NagatoQueue.ChannelPlayControl.Play()
    NagatoQueue.ChannelCoverArt.Reload()
    
End

Public Function GetPicture(argPath As String, argSize As Integer) As Picture
    
    $workingDirectory.Ensure()
    Try Shell Subst$("eyeD3 -i &1 &2", $workingDirectory.Path, Quote$(argPath)) Wait
    If $workingDirectory.HasFile Then Return getPictureFormWorkingDirectory(argSize)

Finally
    Return Null
    
End

Public Sub SetPicture(argPicturePath As String, argMusicPath As String)
    
    If (Media.URL(argMusicPath) = NagatoQueue.ChannelList.CurrentUrl) Then
        setAlbumArtToCurrentPlayingFile(argPicturePath, argMusicPath)
    Else
        setAlbumArtToFile(argPicturePath, argMusicPath)
    Endif
    
End
