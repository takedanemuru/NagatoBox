' Gambas class file

Inherits NagatoQueueAssistant

Private $observer As Observer

Private Sub pause()
    
    If Not Me._$player.State = Media.Paused Then Return
    Me._$player.Pause()
    Raise Signal(MikuruSignal.BroadcastStateChanged, Null)
    
End

Private Sub move(argSignal As Integer, argPlayState As Integer)
    
    Me._$player.Stop()
    Me._$musicList(argSignal, Null)
    Me._$player.ResetUrl(argPlayState = Media.Playing)
    Raise Signal(MikuruSignal.BroadcastIndexMoved, Null)
    
End

Private Sub back()
    
    Dim yukiPlayState As Integer = Me._$player.State
    
    If yukiPlayState = Media.Playing And If Me._$player.GetDurationData().Rate > 0.05 Then
        Me._$player.SetByRate(0)
    Else
        move(MikuruSignal.QueueBack, yukiPlayState)
    End If
    
End

Private Sub setIndexAndPlay(argIndex As Integer)
    
    Me._$player.Stop()
    Me._$musicList.SetIndex(argIndex)
    Me._$player.ResetUrl(True)
    
    Raise Signal(MikuruSignal.BroadcastIndexMoved, Null)
    
End

Public Sub _call(argSignal As Integer, argvalues As Variant[])
    
    If Not Me._$musicList.HasElement Then Return

    Select Case argSignal
        Case MikuruSignal.QueuePlay
            Me._$player.TryPlay()
            Raise Signal(MikuruSignal.BroadcastStateChanged, Null)
        Case MikuruSignal.QueuePause
            pause()
        Case MikuruSignal.QueueBack
            back()
        Case MikuruSignal.QueueNext
            move(argSignal, Me._$player.State)
        Case MikuruSignal.QueueSetVolume
            Me._$player.SoftwareVolume = argvalues[0]
        Case MikuruSignal.QueueSeek
            Me._$player.SetByRate(argvalues[0])
        Case MikuruSignal.QueSetIndexAndPlay
            setIndexAndPlay(argvalues[0])
    End Select
    
End

Public Sub _OptionalOnInitialize()
    
    $observer = New Observer(Me._$player) As "Asakura"
    
End

Public Sub Asakura_MusicEnd()
    
    If NagatoSettingsMusic.Repeat Then Me._$player.SetByRate(0)
    If Not NagatoSettingsMusic.Repeat Then move(MikuruSignal.QueueNext, Media.Playing)
    
End
