' Gambas class file

Inherits NagatoDesktopTile2

Private $descriptionPainter As NagatoDescriptionPainterStandard
Private $rssFeeds As NagatoDesktopTileContentRssFeeds
Private $timer As New Timer As "Timer"

Private Sub setBackgroundColor()
    
    If $rssFeeds.HasThumbnail Then
        $descriptionPainter.BackgroundColor = MikuruColor.Transparent(Color.Gray, 192)
    Else
        $descriptionPainter.BackgroundColor = Color.Transparent
    Endif
    
End

Private Function getBaseImage(argTitle As String) As Image
    
    If $rssFeeds.HasThumbnail Then
        Return $rssFeeds.GetThumbnail(argTitle)
    Else
        Return MikuruTileBaseImage[Color.Orange, 192]
    Endif
    
End

Public Function getIcon() As Picture
    
    Dim yukiImage As Image = getBaseImage($rssFeeds.Title)
    
    Paint.Begin(yukiImage)
        setBackgroundColor()
        $descriptionPainter.Paint($rssFeeds.Title)
        NagatoLabelPainterFacade(MikuruTileMode.SpecialRssText)
    Paint.End()
    
    Return yukiImage.Picture
    
Catch
    Return MikuruTileBaseImage[Color.Orange, 128].Picture
    
End

Public Sub _OnReload()
    
    Try Me._$iconView.Remove(NagatoDesktopKey.RssFeeder)
    If Not NagatoSettingsDesktopTile.GetVisible(NagatoDesktopKey.RssFeeder) Then Return
    
    Me._$iconView.Add(NagatoDesktopKey.RssFeeder, "", getIcon())
    
End

Public Sub _OnTimer() ' override
    
    If Not $timer.Enabled Then $timer.Enabled = True
    
    ' If Not Me._$iconView.Exist(NagatoDesktopKey.RssFeeder) Then Return
    ' If Not $rssFeeds.EnsureActivation() Then Return
    ' 
    ' Me._$iconView[NagatoDesktopKey.RssFeeder].Picture = getIcon()
    
End

Public Sub _OptionalOnInitialize()
    
    $descriptionPainter = New NagatoDescriptionPainterStandard(Color.Transparent)
    $rssFeeds = New NagatoDesktopTileContentRssFeeds
    $rssFeeds.ClearThumbnails()
    
End

Public Sub Timer_Timer()
    
    If Not Me._$iconView.Exist(NagatoDesktopKey.RssFeeder) Then Return
    If Not $rssFeeds.EnsureActivation() Then Return
    
    Me._$iconView[NagatoDesktopKey.RssFeeder].Picture = getIcon()
    
End
