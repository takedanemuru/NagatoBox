' Gambas class file

Property Read MainTabStrip As TabStrip
Property Read MessagingArea As DrawingArea
Property Read GlobalSearchBox As HBox
Property Read Settings As Settings

Private $globalSearchBox As NagatoGlobalSearchBox
Private $settings As New Settings
Private $observer As Observer

Public Sub Form_Open()
    
    Application.MainWindow = Me
    
    MikuruEasterEgg.Check()
    Debug "easter-egg: " & Now() 
    NagatoSettingsCore.LoadFormSettings(Me)
    Debug "load form settings" & Now()
    NagatoFace.Activate()
    Debug "activate face" & Now()
    $observer = New Observer(MainTabPanel) As "Asakura"
    Debug "instanciate main tab panel observer" & Now()
    MainTabPanel.Orientation = NagatoSettingsCore.TabPosition
    Debug "set main tab panel orientation " & Now()
    NagatoTabHandler.NewTab(MikuruFunctionType.FileSelector, True)
    Debug "instanciate file selector " & Now()
    NagatoMessaging.ShowVersion()
    Debug "show version" & Now()
    $globalSearchBox = New NagatoGlobalSearchBox(SearchBoxContainer)
    Debug "instanciate global search box"
    NagatoFormHandler.SetWidgetPositionAndSize()
    Debug "set widget position and size: " & Now() 
    NagatoDBWeb.ResizeRecentPages()
    Debug "resize nagato-db-web recent-pages: " & Now()
    NagatoWebbookmarkCache.Activate()
    Debug "activate bookmark cache: " & Now()

End

Public Sub Form_Close()
    
    If HaruhiQuit.ShowDialog() <> 1 Then Stop Event
    
    NagatoFace.KillTimer()
    NagatoSettingsCore.SaveFormSettings(Me)

End

Public Sub Form_Resize()
    
    NagatoFormHandler.SetWidgetPositionAndSize()
    
End

Public Sub Form_KeyPress()
    
    If Key.Code = Key.F11 Then Me.FullScreen = Not Me.FullScreen
    
End

Public Sub Asakura_Close(argIndex As Integer)
    
    ' $observer should intercept MainTabPanel's close event with its index argument.
    ' To destroy all inner tab contents before specified tab shouled be closed.
    '  because Gambas3 couldn't close tab that has any container.
   
   If MainTabPanel.Count = 1 Then
        Stop Event
        Return
   Endif
   
   MainTabPanel[argIndex].Children[0].Delete()
   MainTabPanel[argIndex].Delete()
    
End

Private Function Settings_Read() As Settings

    Return $settings

End

Private Function MainTabStrip_Read() As TabStrip

    Return MainTabPanel

End

Private Function MessagingArea_Read() As DrawingArea

    Return NagatoFaceDA

End

Private Function GlobalSearchBox_Read() As HBox

    Return SearchBoxContainer

End

Public Sub NagatoFaceDA_MouseDown()

    Dim yukiMenu As New NagatoAppMenu(Me) 
    
    yukiMenu.popup()

End

Public Sub NagatoFaceDA_Menu()

    Dim yukiMenu As New NagatoAppMenu(Me) 
    
    yukiMenu.popup()

End
