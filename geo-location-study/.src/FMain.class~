' Gambas class file

Private Const NominatimApi As String = "http://nominatim.openstreetmap.org/search?q=&1&format=xml"

Private $httpClient As New HttpClient As "httpClient"
Private $buffer As String 
Private $xml As New XmlDocument

Private Sub parseBuffer()
    
    Dim yukiNode As XmlNode
    
    $xml.FromString($buffer)
    
    For Each yukiNode In $xml.GetElementsByTagName("searchresults")[0].AllChildNodes
        With yukiNode
            If .Attributes["display_name"] = "" Then Continue
            Debug .Attributes["display_name"]
            Debug .Attributes["lat"]
            Debug .Attributes["lon"]
        End With
    Next
    
End

Private Sub startDownloading()
    
     $buffer = ""
    
    With $httpClient
        .URL = Subst$(NominatimApi, Quote$(TextBox1.Text))
        .Async = True
        .Timeout = 20
    End With
    
    $httpClient.Get()
    
End

Public Sub StartButton_Click()

    If TextBox1.Text <> "" And If IsAscii(TextBox1.Text) And If InStr(TextBox1.Text, " ") = 0 Then
        startDownloading()
    Endif

End

Public Sub HttpClient_Read()
    
    Dim yukiBuffer As String

  yukiBuffer = Read #Last, Lof(Last)
  $buffer &= yukiBuffer
    
End

Public Sub HttpClient_Finished()
    
    Debug $buffer
    
    parseBuffer()
    
End
