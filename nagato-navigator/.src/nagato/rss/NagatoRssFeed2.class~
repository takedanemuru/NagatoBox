' Gambas class file

Property Read Max As Integer

Private $buffer As String 
Private $titles As New String[]
Private $links As New String[]

Private $httpClient As New HttpClient As "Asakura"
Private $xmlDocument As New XmlDocument

Event Error
Event Finish(argFeed As NagatoRssFeed)

Private Sub removeStyleSheet(argBuffer As String) As String
    
    Dim yukiLine As String
    Dim yukiResult As String
    
    For Each yukiLine In Split(argBuffer, "\n", "", True)
        If yukiLine Not Begins "<?xml-stylesheet" Then
            Try yukiResult &= yukiLine
        End If
    Next
    
    Return yukiResult
    
End

Private Sub setItems(argData As String)
    
    Dim yukiItem As XmlElement
    Dim yukiTitle As String
    Dim yukiUrl As String
    
    $xmlDocument.FromString(removeStyleSheet(argData))
    
    'Debug removeStyleSheet(argData)
    
    ' For Each yukiItem In $xmlDocument.GetElementsByTagName("item")
    '     Try yukiTitle = yukiItem.GetChildrenByTagName("title")[0].Value
    '     Try yukiUrl = yukiItem.GetChildrenByTagName("link")[0].Value
    '     If yukiTitle <> "" And If yukiUrl <> "" Then
    '         $titles.Add(yukiTitle)
    '         $links.Add(yukiUrl)
    '     Endif
    ' Next
    ' 
    Raise Finish(Me)
    
Catch
    Return
    
End

Public Sub _new(argPath As String)
    
    $buffer = ""
    
    With $httpClient
        .URL = argPath
        .Timeout = 60
        .Get()
    End With
    
End

Public Sub GetTitle(argIndex As Integer) As String
    
    Return $titles[argIndex]
    
End

Public Sub GetLink(argIndex As Integer) As String
    
    Return $links[argIndex]
    
End

Public Sub GetMax() As Integer
    
    Return $titles.Max
    
End

Public Sub Asakura_Read()
    
    Dim yukiBuffer As String
    
    yukiBuffer = Read #Last, Lof(Last)
    $buffer &= yukiBuffer
    
End

Public Sub Asakura_Error()
    
    Raise Error
    
End

Public Sub Asakura_Finished()
    
    setItems($buffer)
    
End

Private Function Max_Read() As Integer

    Return $titles.Max

End

