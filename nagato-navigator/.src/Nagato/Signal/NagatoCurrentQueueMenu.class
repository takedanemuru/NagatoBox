' Gambas class file

Inherits NagatoSubMenu

Private Const ApplicationName As String = "org.gambas.nagato.player.x"
Private Const ObjectPath As String = "/org/nagato/player/x"
Private Const Interface As String = "org.gambas.nagato.player.x.nagatointerface"

Private $proxy As DBusProxy

Public Sub _InitializeParentMenu(argRootMenu As Menu)
    
    Me._$parentMenu = New Menu(argRootMenu) As "ParentMenu"
    
    With Me._$parentMenu
        .Text = ("Queue")
        .Picture = MikuruIcon.Get("music")
    End With
    
End

Private Sub refreshMenu()
    
    Dim yukiPath As String
    Dim yukiMenu As Menu
    Dim yukiIndex As Integer
    Dim yukiCollection As Collection 
    
    Me._$parentMenu.Children.Clear()
    
    For Each yukiPath In $proxy.Paths
        yukiMenu = New Menu(Me._$parentMenu) As "QueueMenu"
        yukiMenu.Tag = yukiPath
        yukiMenu.Text = MikuruCollapsedText.Get($proxy.GetTitle(yukiPath), Application.Font, 300)
        If yukiMenu.Text = $proxy.Title Then yukiMenu.Picture = MikuruIcon.Get("button-play")
        If Me._$parentMenu.Children.Count > 60 Then Break
    Next
    
End

Public Sub _InitializeMenus()
    
    Me._AddMenu("", 0) ' as dummy menu to get "Show" event
    
End

Public Sub ParentMenu_Show()
    
    $proxy = DBus[ApplicationName][ObjectPath, Interface]
    refreshMenu()
    
' Catch
'     Me._$parentMenu.Children.Clear()
'     Me._AddMenu("Couldn't conect to nagato-player-x", 0)
    
End

Public Sub QueueMenu_Click()
    
    $proxy.PlayPathInQueue(Last.Tag)
    
End
