' Gambas class file

Private Const Margin As Integer = 2

Private $button As NagatoStarButton
Private $contentBar As NagatoContentBar
Private $pager As NagatoPager
Private $clock As NagatoClock
Private $systrayDrawingArea As DrawingArea

Private Sub setForm()
    
    Me.H = 3 * MikuruUx.Grid
    Me.W = Screen.W
    Me.Y = Screen.H - Me.H
    Me.X = 0
    
End

Private Sub setNetWmWindowType()
    
    Dim yukiWindowType As String = "_NET_WM_WINDOW_TYPE"
    Dim yukiWindowTypeDock As String = "_NET_WM_WINDOW_TYPE_DOCK"
    
    Shell Subst("xprop -id &1 -f &2 32a -set &2 &3", Me.Id, yukiWindowType, yukiWindowTypeDock) Wait
    
End

Private Sub setNetWmStrut()
    
    Dim yukiProperty As String = "_NET_WM_STRUT"
    Dim yukiValue As String = Subst$("0,0,0,&1", Me.H) 
    
    Shell Subst("xprop -id &1 -f &2 32c -set &2 &3", Me.Id, yukiProperty, yukiValue)
    
End

Private Sub setSystray()
    
    $systrayDrawingArea = New DrawingArea(Me)
    
    With $systrayDrawingArea
        .W = 200
        .Background = Color.Red
    End With
    
End

Public Sub Form_Open()

    setForm()
    setNetWmStrut()
    setNetWmWindowType()
    NagatoTimer.Activate()

    Me.Background = NagatoSettings.BackgroundColor
    $button = New NagatoStarButton(Me) As "StarButton"
    $contentBar = New NagatoContentBar(Me) As "ContentBar"
    'setSystray()
    $pager = New NagatoPager(Me) As "Pager"
    $clock = New NagatoClock(Me) As "Clock"
    
    'X11Systray.Show($systrayDrawingArea.Id)
    
End

Public Sub Form_Close()
    
    NagatoDBus.Unregister()
    
End

Public Sub Form_Enter()

    If Not NagatoSettings.ShowNagato Then Return

    If Mouse.ScreenY > Screen.H - 2 Then HaruhiPersona.EnsureVisible()
        
End

Public Sub Form_Move()
    
    setForm()
    
End

Public Sub StarButton_Signal(argSignal As Integer, argValues As Variant[])
    
    If argSignal = MikuruSignal.ModeChanged Then
        $contentBar.Swich(argValues[0])
    Endif
    
End

Public Sub ArrangeTray() ' X11systray cannot call private sub.

    Dim yukiIndex As Integer
    Dim yukiX As Integer = Margin
    
    For yukiIndex = 0 To X11Systray.Count - 1
        With X11Systray[yukiIndex]
            .Move(yukiX, Margin, .IconW, .IconH)
            yukiX += .IconW + Margin
        End With
    Next
  
End

Public Sub Form_Resize()
  
    Me.ArrangeTray()

End

Static Public Sub X11Systray_Arrange()

    Me.ArrangeTray()
  
End
